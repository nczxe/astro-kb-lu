---
const pollInterval = 1000 * 60 * 5; // 5 minutes
let updates = [];
---

<section class="update-list" aria-live="polite">
  <h3>更新记录</h3>
  <div id="updates-root">
    <p>正在加载最新提交……</p>
  </div>
</section>

<script type="module" define:vars={{pollInterval}}>
  const root = document.getElementById('updates-root');
  async function fetchUpdates(){
    try{
      const res = await fetch('/api/updates.json');
      if(!res.ok) throw new Error('fetch failed');
      const data = await res.json();
      render(data.results || []);
    }catch(e){
      if(root) root.innerHTML = `<p>加载失败：${String(e)}</p>`;
    }
  }

  function render(results){
    if(!root) return;
    if(!results.length){
      root.innerHTML = '<p>未找到更新。</p>';
      return;
    }
    const parts = results.map(r => {
      if(r.error) return `<div class="repo"><strong>${r.label}</strong>: <em>${r.error}</em></div>`;
      const items = (r.commits||[]).slice(0,5).map(c => `
        <li>
          <a href="${c.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(c.message.split('\n')[0]||c.sha)}</a>
          <div class="meta">${escapeHtml(c.author||'')}&nbsp;·&nbsp;${new Date(c.date).toLocaleString()}</div>
        </li>
      `).join('');
      return `<div class="repo"><strong>${r.label}</strong><ul>${items}</ul></div>`;
    });
    root.innerHTML = parts.join('');
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  fetchUpdates();
  setInterval(fetchUpdates, pollInterval);
</script>

<style>
  .update-list{ padding: 0.5rem; color: rgb(var(--gray)); }
  .update-list h3{ margin: 0 0 0.5rem 0; }
  .repo{ margin-bottom: 0.6rem; }
  .repo ul{ margin: 0.25rem 0 0 0; padding: 0; list-style: none; }
  .repo li{ margin: 0.2rem 0; }
  .repo a{ color: inherit; text-decoration: none; font-weight: 500; }
  .repo .meta{ font-size: 0.78rem; color: rgba(100,100,100,0.9); }
</style>
