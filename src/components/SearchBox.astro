---
// SearchBoxç»„ä»¶ - æä¾›æœç´¢åŠŸèƒ½å¹¶æ”¯æŒæ·±æµ…è‰²æ¨¡å¼

// ç»„ä»¶å±æ€§
interface Props {
  placeholder?: string;
  className?: string;
}

const { 
  placeholder = "æœç´¢çŸ¥è¯†åº“å†…å®¹...",
  className = ""
} = Astro.props;
---

<div class={`search-container ${className}`}>
  <form id="search-form" class="search-form">
    <div class="search-input-wrapper">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input 
        type="text" 
        id="search-input"
        class="search-input"
        placeholder={placeholder}
        autocomplete="off"
      />
      <button 
        type="submit" 
        class="search-button"
        aria-label="æœç´¢"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
      <!-- æ¸…é™¤æŒ‰é’® - åˆå§‹éšè— -->
      <button 
        type="button" 
        class="clear-button"
        aria-label="æ¸…é™¤æœç´¢"
        hidden
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <!-- æœç´¢å»ºè®®å®¹å™¨ - å°†åœ¨åç»­å®ç° -->
    <div class="search-suggestions" id="search-suggestions" hidden>
      <!-- æœç´¢å»ºè®®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- æœç´¢å†å²å®¹å™¨ - å°†åœ¨åç»­å®ç° -->
    <div class="search-history" id="search-history" hidden>
      <!-- æœç´¢å†å²å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </form>
</div>

<style>
.search-container {
  position: relative;
  width: 100%;
  max-width: 400px;
  z-index: 100;
}

.search-form {
  width: 100%;
}

.search-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  width: 100%;
  border-radius: 8px;
  border: 1px solid rgba(var(--gray), 0.3);
  background-color: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(10px);
  overflow: hidden;
  transition: all var(--transition-speed, 0.3s) ease;
  z-index: 101;
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
  html.dark .search-input-wrapper {
    background-color: rgba(var(--gray-light), 0.9);
    border-color: rgba(var(--gray), 0.6);
    backdrop-filter: blur(12px);
  }

  /* ç¡®ä¿æ·±è‰²æ¨¡å¼ä¸‹æœç´¢è¾“å…¥æ¡†å†…å®¹æ¸…æ™°å¯è§ */
  html.dark .search-input {
    color: rgb(var(--white));
    background-color: transparent;
  }

  /* ä¼˜åŒ–æ·±è‰²æ¨¡å¼ä¸‹å ä½ç¬¦æ–‡æœ¬çš„å¯è§æ€§ */
  html.dark .search-input::placeholder {
    color: rgba(var(--gray), 0.8);
  }
  
  /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ¸…é™¤æŒ‰é’® */
  html.dark .clear-button {
    color: rgba(var(--gray), 0.7);
  }

  /* ä¼˜åŒ–æ·±è‰²æ¨¡å¼ä¸‹çš„æœç´¢å»ºè®®å’Œå†å²è®°å½•å®¹å™¨ */
  html.dark .search-suggestions,
  html.dark .search-history {
    background-color: rgba(var(--gray-light), 0.95);
    border-color: rgba(var(--gray), 0.6);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(12px);
  }

/* å·²åœ¨æ·±è‰²æ¨¡å¼é€‚é…éƒ¨åˆ†ä¼˜åŒ– */

/* å·²åœ¨æ·±è‰²æ¨¡å¼é€‚é…éƒ¨åˆ†ä¼˜åŒ– */

/* å·²åœ¨æ·±è‰²æ¨¡å¼é€‚é…éƒ¨åˆ†ä¼˜åŒ– */

html.dark .suggestion-path {
  color: rgba(var(--gray), 0.8);
}

html.dark .empty-state {
  color: rgba(var(--gray), 0.7);
}

html.dark .history-title {
  color: rgba(var(--gray), 0.8);
}

html.dark .history-header {
  border-bottom-color: rgba(var(--gray), 0.3);
}

html.dark .clear-history-button:hover {
  background-color: rgba(var(--accent), 0.15);
}

/* æœç´¢æŒ‰é’®åœ¨æ·±è‰²æ¨¡å¼ä¸‹çš„ä¼˜åŒ– */
html.dark .search-button:hover {
  background-color: var(--accent-dark);
  box-shadow: 0 2px 8px rgba(122, 162, 255, 0.3);
}

/* ä¼˜åŒ–æ·±è‰²æ¨¡å¼ä¸‹çš„èšç„¦æ•ˆæœ */
  html.dark .search-input-wrapper:focus-within {
    box-shadow: 0 0 0 2px rgba(122, 162, 255, 0.3);
    border-color: var(--accent);
  }

/* å·²åœ¨æ·±è‰²æ¨¡å¼é€‚é…éƒ¨åˆ†ä¼˜åŒ– */

/* å·²åœ¨æ·±è‰²æ¨¡å¼é€‚é…éƒ¨åˆ†ä¼˜åŒ– */

/* æ»šåŠ¨æ¡æ ·å¼ */
.search-suggestions::-webkit-scrollbar,
.search-history::-webkit-scrollbar {
  width: 6px;
}

.search-suggestions::-webkit-scrollbar-track,
.search-history::-webkit-scrollbar-track {
  background: rgba(var(--gray-light), 0.5);
  border-radius: 3px;
}

.search-suggestions::-webkit-scrollbar-thumb,
.search-history::-webkit-scrollbar-thumb {
  background: rgba(var(--gray), 0.5);
  border-radius: 3px;
  transition: background var(--transition-speed, 0.3s) ease;
}

.search-suggestions::-webkit-scrollbar-thumb:hover,
.search-history::-webkit-scrollbar-thumb:hover {
  background: rgba(var(--gray), 0.8);
}

html.dark .search-suggestions::-webkit-scrollbar-track,
html.dark .search-history::-webkit-scrollbar-track {
  background: rgba(var(--gray-dark), 0.1);
}

html.dark .search-suggestions::-webkit-scrollbar-thumb,
html.dark .search-history::-webkit-scrollbar-thumb {
  background: rgba(var(--gray), 0.4);
}

html.dark .search-suggestions::-webkit-scrollbar-thumb:hover,
html.dark .search-history::-webkit-scrollbar-thumb:hover {
  background: rgba(var(--gray), 0.6);
}

.search-icon {
  position: absolute;
  left: 12px;
  color: rgb(var(--gray));
  pointer-events: none;
}

.search-input {
  flex: 1;
  padding: 12px 48px 12px 36px;
  font-size: 16px;
  border: none;
  background: transparent;
  color: rgb(var(--gray-dark));
  outline: none;
  transition: color var(--transition-speed, 0.3s) ease;
}

html.dark .search-input {
  color: rgb(var(--black));
}

.search-input::placeholder {
  color: rgba(var(--gray), 0.7);
}

.search-button {
  position: absolute;
  right: 0;
  padding: 12px;
  border: none;
  background: var(--accent);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color var(--transition-speed, 0.3s) ease;
}

html.dark .search-button {
  color: white; /* ç¡®ä¿æ·±è‰²æ¨¡å¼ä¸‹æŒ‰é’®æ–‡å­—é¢œè‰²æ­£ç¡® */
}

.search-button:hover {
  background: var(--accent-dark);
}

.clear-button {
  position: absolute;
  right: 40px;
  padding: 8px;
  border: none;
  background: transparent;
  color: rgb(var(--gray));
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color var(--transition-speed, 0.3s) ease;
}

.clear-button:hover {
  color: rgb(var(--gray-dark));
}

html.dark .clear-button:hover {
  color: rgb(var(--black));
}

/* å†å²è®°å½•é¡¹åœ¨æ·±è‰²æ¨¡å¼ä¸‹çš„æ ·å¼å·²åœ¨ä¸‹æ–¹ç»Ÿä¸€å®šä¹‰ */

/* æœç´¢å»ºè®®å’Œå†å²è®°å½•æ ·å¼ */
.search-suggestions,
.search-history {
	position: absolute;
	top: 100%;
	left: 0;
	right: 0;
	margin-top: 4px;
	border-radius: 8px;
	border: 1px solid rgba(var(--gray), 0.3);
	background-color: white;
	box-shadow: var(--box-shadow);
	max-height: 300px;
	overflow-y: auto;
	z-index: 102;
	transition: all var(--transition-speed, 0.3s) ease;
}

/* å·²åœ¨æ·±è‰²æ¨¡å¼é€‚é…éƒ¨åˆ†ä¼˜åŒ– */

/* å»ºè®®é¡¹æ ·å¼ */
.suggestion-item {
	padding: 10px 16px;
	cursor: pointer;
	transition: background-color var(--transition-speed, 0.3s) ease;
	display: flex;
	align-items: center;
	gap: 10px;
}

.suggestion-item:hover {
	background-color: rgba(var(--gray-light), 0.6);
}

html.dark .suggestion-item:hover {
	background-color: rgba(var(--gray), 0.2);
}

.suggestion-item.active {
	background-color: rgba(var(--accent), 0.1);
}

html.dark .suggestion-item.active {
	background-color: rgba(var(--accent), 0.2);
}

.suggestion-content {
	flex: 1;
}

.suggestion-title {
	font-weight: 500;
	color: rgb(var(--gray-dark));
	line-height: 1.4;
}

html.dark .suggestion-title {
	color: rgb(var(--black));
}

.suggestion-path {
	font-size: 12px;
	color: rgb(var(--gray));
	margin-top: 2px;
}

/* æœç´¢ç»“æœå›¾æ ‡ */
.suggestion-icon {
	color: var(--accent);
	flex-shrink: 0;
}

/* ç©ºçŠ¶æ€æç¤º */
.empty-state {
	padding: 20px 16px;
	text-align: center;
	color: rgb(var(--gray));
	font-size: 14px;
}

/* é«˜äº®æ–‡æœ¬æ ·å¼ */
mark {
	background-color: rgba(var(--accent), 0.2);
	color: inherit;
	padding: 0 2px;
	border-radius: 2px;
}

html.dark mark {
	background-color: rgba(var(--accent), 0.3);
}

/* å†å²è®°å½•å¤´éƒ¨ */
.history-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 8px 16px;
	border-bottom: 1px solid rgba(var(--gray), 0.2);
}

.history-title {
	font-size: 12px;
	font-weight: 500;
	color: rgb(var(--gray));
}

.clear-history-button {
	font-size: 12px;
	color: var(--accent);
	background: none;
	border: none;
	cursor: pointer;
	padding: 4px 8px;
	border-radius: 4px;
	transition: background-color var(--transition-speed, 0.3s) ease;
}

.clear-history-button:hover {
	background-color: rgba(var(--accent), 0.1);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .search-container {
    max-width: 100%;
  }
  
  .search-input {
    font-size: 14px;
    padding: 10px 40px 10px 32px;
  }
  
  .search-icon,
  .search-button svg {
    width: 18px;
    height: 18px;
  }
  
  .search-button {
    padding: 10px;
  }
  
  .clear-button {
    right: 36px;
  }
}

/* èšç„¦æ•ˆæœ */
.search-input-wrapper:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(35, 55, 255, 0.2);
}

html.dark .search-input-wrapper:focus-within {
  box-shadow: 0 0 0 2px rgba(122, 162, 255, 0.3);
}
</style>

<script>
// æœç´¢æ¡†åŠŸèƒ½å®ç°
// æ·»åŠ ç±»å‹å£°æ˜
interface DocumentItem {
  id: string;
  title: string;
  path: string;
  icon: string;
}

// ä½¿ç”¨æ›´ç²¾ç¡®çš„DOMç±»å‹
const searchInput = document.getElementById('search-input') as HTMLInputElement | null;
const clearButton = document.querySelector('.clear-button') as HTMLButtonElement | null;
const searchForm = document.getElementById('search-form') as HTMLFormElement | null;
const suggestionsContainer = document.getElementById('search-suggestions') as HTMLDivElement | null;
const historyContainer = document.getElementById('search-history') as HTMLDivElement | null;

// é¡¹ç›®æ–‡æ¡£æ•°æ® - åŸºäºå®é™…é¡¹ç›®ç»“æ„
const projectDocuments: DocumentItem[] = [
	// ä¸­æ–‡æ–‡æ¡£
	{ id: 'zh-docs-index', title: 'æ–‡æ¡£é¦–é¡µ', path: '/docs/', icon: 'ğŸ“‹' },
	{ id: 'zh-docs-updates', title: 'æ›´æ–°æ—¥å¿—', path: '/docs/updates', icon: 'ğŸ“…' },
	
	// è‹±æ–‡æ–‡æ¡£
	{ id: 'en-docs-index', title: 'Documentation Home', path: '/en/docs/', icon: 'ğŸ“‹' },
	{ id: 'en-docs-getting-started', title: 'Getting Started', path: '/en/docs/getting-started', icon: 'ğŸš€' },
	
	// åšå®¢
	{ id: 'blog-index', title: 'åšå®¢é¦–é¡µ', path: '/blog/', icon: 'ğŸ“' },
	
	// å…¶ä»–é¡µé¢
	{ id: 'home', title: 'é¦–é¡µ', path: '/', icon: 'ğŸ ' },
	{ id: 'about', title: 'å…³äºæˆ‘ä»¬', path: '/about', icon: 'â„¹ï¸' }
];

// å¯ä»¥æ‰©å±•æ”¯æŒæ›´å¤šæ–‡ä»¶ç±»å‹å’Œè·¯å¾„
function getAllProjectDocuments(): DocumentItem[] {
	return projectDocuments;
}

// æœç´¢å»¶è¿Ÿè®¡æ—¶å™¨
let searchTimeout: NodeJS.Timeout | null = null;

// æ·»åŠ ç©ºå€¼æ£€æŸ¥
if (searchInput && clearButton) {
	// ç›‘å¬è¾“å…¥äº‹ä»¶ï¼Œæ§åˆ¶æ¸…é™¤æŒ‰é’®æ˜¾ç¤º/éšè—å’Œæœç´¢å»ºè®®
	searchInput.addEventListener('input', () => {
		const query = searchInput.value.trim();
		
		// æ§åˆ¶æ¸…é™¤æŒ‰é’®æ˜¾ç¤º/éšè—
		if (query && clearButton) {
			clearButton.removeAttribute('hidden');
			// æ˜¾ç¤ºæœç´¢å†å²ï¼ˆå¦‚æœæœ‰ï¼‰
			displaySearchHistory(query);
			// å»¶è¿Ÿæœç´¢ï¼Œé¿å…é¢‘ç¹è§¦å‘
			if (searchTimeout) {
				clearTimeout(searchTimeout);
			}
			searchTimeout = setTimeout(() => {
				showSearchSuggestions(query);
			}, 300);
		} else if (clearButton) {
			clearButton.setAttribute('hidden', '');
			// æ¸…ç©ºæ—¶éšè—æœç´¢å»ºè®®å’Œå†å²è®°å½•
			hideSuggestionsAndHistory();
		}
	});
}

// æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
if (clearButton && searchInput) {
	clearButton.addEventListener('click', () => {
		if (searchInput) {
			searchInput.value = '';
			// é‡æ–°è·å–ç„¦ç‚¹
			searchInput.focus();
		}
		if (clearButton) {
			clearButton.setAttribute('hidden', '');
		}
		// éšè—æœç´¢å»ºè®®å’Œå†å²è®°å½•
		hideSuggestionsAndHistory();
	});
}

// è¡¨å•æäº¤äº‹ä»¶
if (searchForm && searchInput) {
	searchForm.addEventListener('submit', (e: Event) => {
		e.preventDefault();
		const query = searchInput.value.trim();
		if (query) {
			// æ‰§è¡Œæœç´¢å¹¶ä¿å­˜åˆ°å†å²è®°å½•
			executeSearch(query);
			// éšè—æœç´¢å»ºè®®å’Œå†å²è®°å½•
			hideSuggestionsAndHistory();
		}
	});
}

// é”®ç›˜å¯¼èˆªäº‹ä»¶
if (searchInput) {
	searchInput.addEventListener('keydown', (e: KeyboardEvent) => {
		const activeSuggestions = document.querySelectorAll('.suggestion-item:not([hidden])');
		const activeItems = Array.from(activeSuggestions) as HTMLElement[];
		const currentActive = document.querySelector('.suggestion-item.active') as HTMLElement | null;
		const currentIndex = currentActive ? activeItems.indexOf(currentActive) : -1;
		
		switch (e.key) {
			case 'ArrowDown':
				e.preventDefault();
				// ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå»ºè®®é¡¹
				if (currentActive) currentActive.classList.remove('active');
				const nextIndex = currentIndex < activeItems.length - 1 ? currentIndex + 1 : 0;
				if (activeItems[nextIndex]) {
					activeItems[nextIndex].classList.add('active');
					// æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
					activeItems[nextIndex].scrollIntoView({ block: 'nearest' });
				}
				break;
			case 'ArrowUp':
				e.preventDefault();
				// ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªå»ºè®®é¡¹
				if (currentActive) currentActive.classList.remove('active');
				const prevIndex = currentIndex > 0 ? currentIndex - 1 : activeItems.length - 1;
				if (activeItems[prevIndex]) {
					activeItems[prevIndex].classList.add('active');
					// æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
					activeItems[prevIndex].scrollIntoView({ block: 'nearest' });
				}
				break;
			case 'Enter':
				// å¦‚æœæœ‰æ´»åŠ¨çš„å»ºè®®é¡¹ï¼Œç‚¹å‡»å®ƒ
				if (currentActive) {
					e.preventDefault();
					currentActive.click();
					return;
				}
				// å¦åˆ™æäº¤è¡¨å•
				break;
			case 'Escape':
				// éšè—å»ºè®®å’Œå†å²è®°å½•
				hideSuggestionsAndHistory();
				break;
		}
	});
}

// æ˜¾ç¤ºæœç´¢å»ºè®®
function showSearchSuggestions(query: string) {
	if (!query || !suggestionsContainer || !historyContainer) {
		return;
	}
	
	// è·å–é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡æ¡£
	const allDocuments = getAllProjectDocuments();
	
	// ç®€å•çš„æ¨¡ç³Šæœç´¢è¿‡æ»¤
	const filteredSuggestions = allDocuments.filter(item => 
		item.title.toLowerCase().includes(query.toLowerCase()) ||
		item.path.toLowerCase().includes(query.toLowerCase())
	);
	
	// æ¸…ç©ºå»ºè®®å®¹å™¨
	suggestionsContainer.innerHTML = '';
	
	if (filteredSuggestions.length === 0) {
		// æ˜¾ç¤ºæ— ç»“æœçŠ¶æ€
		const emptyState = document.createElement('div');
		emptyState.className = 'empty-state';
		emptyState.textContent = `æ²¡æœ‰æ‰¾åˆ°ä¸"${query}"ç›¸å…³çš„å†…å®¹`;
		suggestionsContainer.appendChild(emptyState);
	} else {
		// æ·»åŠ æœç´¢å»ºè®®é¡¹
		filteredSuggestions.forEach((suggestion: DocumentItem, index: number) => {
			const item = document.createElement('div');
			item.className = `suggestion-item ${index === 0 ? 'active' : ''}`;
			item.dataset.path = suggestion.path;
			item.dataset.title = suggestion.title;
			
			// è®¾ç½®å»ºè®®é¡¹å†…å®¹
			item.innerHTML = `
				<div class="suggestion-icon">${suggestion.icon}</div>
				<div class="suggestion-content">
					<div class="suggestion-title">${highlightText(suggestion.title, query)}</div>
					<div class="suggestion-path">${suggestion.path}</div>
				</div>
			`;
			
			// æ·»åŠ ç‚¹å‡»äº‹ä»¶
			item.addEventListener('click', () => {
				// æ›´æ–°æœç´¢è¾“å…¥
				if (searchInput) {
					searchInput.value = suggestion.title;
				}
				// æ‰§è¡Œæœç´¢
				executeSearch(suggestion.title, suggestion.path);
				// éšè—å»ºè®®
				hideSuggestionsAndHistory();
			});
			
			suggestionsContainer.appendChild(item);
		});
	}
	
	// æ˜¾ç¤ºå»ºè®®å®¹å™¨ï¼Œéšè—å†å²å®¹å™¨
	suggestionsContainer.removeAttribute('hidden');
	historyContainer.setAttribute('hidden', '');
}

// æ˜¾ç¤ºæœç´¢å†å²
function displaySearchHistory(query: string): void {
	// ä»localStorageè·å–æœç´¢å†å²
	const history = getSearchHistory();
	
	if (history.length === 0) {
		if (historyContainer) {
			historyContainer.setAttribute('hidden', '');
		}
		return;
	}
	
	// è¿‡æ»¤å†å²è®°å½•
	const filteredHistory = query
		? history.filter(item => item.toLowerCase().includes(query.toLowerCase()))
		: history;
	
	if (filteredHistory.length === 0) {
		if (historyContainer) {
			historyContainer.setAttribute('hidden', '');
		}
		return;
	}
	
	// æ¸…ç©ºå†å²å®¹å™¨
	if (historyContainer) {
		historyContainer.innerHTML = '';
	}
	
	// æ·»åŠ å†å²è®°å½•å¤´éƒ¨ï¼ˆä»…åœ¨æ˜¾ç¤ºå®Œæ•´å†å²æ—¶ï¼‰
	if (!query && historyContainer) {
		const header = document.createElement('div');
		header.className = 'history-header';
		header.innerHTML = `
			<span class="history-title">æœ€è¿‘æœç´¢</span>
			<button class="clear-history-button">æ¸…ç©º</button>
		`;
		historyContainer.appendChild(header);
		
		// æ·»åŠ æ¸…ç©ºå†å²è®°å½•äº‹ä»¶
		const clearButton = header.querySelector('.clear-history-button');
		if (clearButton) {
			clearButton.addEventListener('click', (e) => {
				e.stopPropagation();
				clearSearchHistory();
				if (historyContainer) {
					historyContainer.setAttribute('hidden', '');
				}
			});
		}
	}
	
	// æ·»åŠ æœç´¢å†å²é¡¹
	filteredHistory.forEach((item, index) => {
		const historyItem = document.createElement('div');
		historyItem.className = 'suggestion-item';
		historyItem.dataset.query = item;
		
		// è®¾ç½®å†å²é¡¹å†…å®¹
		historyItem.innerHTML = `
			<div class="suggestion-icon">ğŸ•</div>
			<div class="suggestion-content">
				<div class="suggestion-title">${highlightText(item, query)}</div>
				<div class="suggestion-path">æœç´¢å†å²</div>
			</div>
		`;
		
		// æ·»åŠ ç‚¹å‡»äº‹ä»¶
		historyItem.addEventListener('click', () => {
			// æ›´æ–°æœç´¢è¾“å…¥
			if (searchInput) {
				searchInput.value = item;
			}
			// æ‰§è¡Œæœç´¢
			executeSearch(item);
			// éšè—å»ºè®®å’Œå†å²
			hideSuggestionsAndHistory();
		});
		
		if (historyContainer) {
			historyContainer.appendChild(historyItem);
		}
	});
	
	// å¦‚æœç”¨æˆ·æ²¡æœ‰è¾“å…¥æŸ¥è¯¢ï¼Œæ˜¾ç¤ºå†å²è®°å½•
	if (!query) {
		if (historyContainer) {
			historyContainer.removeAttribute('hidden');
		}
		if (suggestionsContainer) {
			suggestionsContainer.setAttribute('hidden', '');
		}
	}
}

// æ¸…ç©ºæœç´¢å†å²
function clearSearchHistory(): void {
	try {
		localStorage.removeItem('searchHistory');
		console.log('æœç´¢å†å²å·²æ¸…ç©º');
	} catch (e) {
		console.error('æ— æ³•æ¸…ç©ºæœç´¢å†å²:', e);
	}
}
// æ‰§è¡Œæœç´¢
function executeSearch(query: string, path?: string | null): void {
	console.log('æ‰§è¡Œæœç´¢:', query, 'è·¯å¾„:', path);
	
	// ä¿å­˜åˆ°æœç´¢å†å²
	saveToSearchHistory(query);
	
	// å¦‚æœæœ‰æŒ‡å®šè·¯å¾„ï¼Œè·³è½¬åˆ°è¯¥é¡µé¢
	if (path) {
		window.location.href = path;
		return;
	}
	
	// å®é™…é¡¹ç›®ä¸­è¿™é‡Œå¯èƒ½éœ€è¦è·³è½¬åˆ°æœç´¢ç»“æœé¡µé¢
	// æˆ–é€šè¿‡å…¶ä»–æ–¹å¼å¤„ç†æœç´¢ç»“æœ
	alert(`æœç´¢: "${query}"\n(å®é™…é¡¹ç›®ä¸­åº”è·³è½¬åˆ°æœç´¢ç»“æœé¡µé¢)`);
}

// ä¿å­˜æœç´¢åˆ°å†å²è®°å½•
function saveToSearchHistory(query: string): void {
	// ä»localStorageè·å–ç°æœ‰å†å²
	let history = getSearchHistory();
	
	// ç§»é™¤é‡å¤é¡¹
	history = history.filter(item => item !== query);
	
	// æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
	history.unshift(query);
	
	// é™åˆ¶å†å²è®°å½•æ•°é‡
	if (history.length > 10) {
		history = history.slice(0, 10);
	}
	
	// ä¿å­˜åˆ°localStorage
	localStorage.setItem('searchHistory', JSON.stringify(history));
}

// è·å–æœç´¢å†å²
function getSearchHistory(): string[] {
	try {
		const history = localStorage.getItem('searchHistory');
		return history ? JSON.parse(history) : [];
	} catch (e) {
		console.error('æ— æ³•è·å–æœç´¢å†å²:', e);
		return [];
	}
}

// éšè—å»ºè®®å’Œå†å²è®°å½•
function hideSuggestionsAndHistory(): void {
	if (suggestionsContainer) {
		suggestionsContainer.setAttribute('hidden', '');
	}
	if (historyContainer) {
		historyContainer.setAttribute('hidden', '');
	}
	// ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
	document.querySelectorAll('.suggestion-item.active').forEach(item => {
		item.classList.remove('active');
	});
}

// é«˜äº®æœç´¢æ–‡æœ¬
function highlightText(text: string, query: string): string {
	if (!text || !query) return text;
	const regex = new RegExp(`(${query})`, 'gi');
	return text.replace(regex, '<mark>$1</mark>');
}

// å¤„ç†ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢å»ºè®®/å†å²è®°å½•
document.addEventListener('click', (e: MouseEvent) => {
	const searchContainer = document.querySelector('.search-container');
	// ä¿®å¤EventTargetåˆ°Nodeçš„ç±»å‹è½¬æ¢é—®é¢˜
	if (searchContainer && e.target instanceof Node && !searchContainer.contains(e.target)) {
		hideSuggestionsAndHistory();
	}
});
</script>